<!-- markdownlint-disable MD038 -->

# Repository Guidelines

This repository contains the source code and documentation for Base UI: a headless, unstyled React component library.

## Project structure

- Source code for components and private utils is in `packages/react/`.
- Source code for public shared utils is in `packages/utils/`.
- Experiments are located at `docs/src/app/(private)/experiments/`. Use for creating demos that require manual testing in the browser.
- Public documentation is located at `docs/src/app/(docs)/react/`. Alter the docs where necessary when changes must be visible to library users.
- When creating public demos on the docs, refer to the `hero` demo for the given component and largely follow its styles (both CSS Modules and Tailwind CSS versions). Other demos may also contain relevant styling. Do not add custom styling beyond the critical layout styles necessary for new demos.

## Code guidelines

- Always use the `useTimeout` utility from `@base-ui/utils/useTimeout` instead of `window.setTimeout`, and `useAnimationFrame` from `@base-ui/utils/useAnimationFrame` instead of `requestAnimationFrame`. Search for other example usage in the codebase if unsure how to use them.
- Use the `useStableCallback` utility from `@base-ui/utils/useStableCallback` instead of `React.useCallback` if the function is called within an effect or event handler. The utility cannot be used to memoize functions that are called directly in the body of a component (during render), so continue with `React.useCallback` in those scenarios.
- Always use the `useIsoLayoutEffect` utility from `@base-ui/utils/useIsoLayoutEffect` instead of `React.useLayoutEffect`.
- Avoid duplicating logic where necessary. If two components can share logic (such as event handlers), define the logic/handlers in the parent and share it through a context to the child; use the existing context if it exists.

## Linting, typechecking, and formatting

- Do not randomly cast (for example `as any`) if there are no type errors without doing so. Run `pnpm typescript` to verify types.
- Ensure your changes pass linting - run `pnpm eslint`.
- Ensure your styles pass stylelint - run `pnpm stylelint`.
- Ensure your markdown passes markdownlint - run `pnpm markdownlint`.
- Ensure your changes are formatted correctly - run `pnpm prettier`.
- When you change a public component API (props or JSDoc), run `pnpm docs:api`.

## Testing

- Run tests in JSDOM env with `pnpm test:jsdom {name} --no-watch` such as `pnpm test:jsdom NumberField --no-watch` or `pnpm test:jsdom parse --no-watch`.
- Run tests in Chromium env with `pnpm test:chromium {name} --no-watch` such as `pnpm test:chromium NumberField --no-watch` or `pnpm test:jsdom parse --no-watch`.
- If you made changes to the source code, ensure you verify your changes by running tests (see above), and writing new tests where applicable. If tests require the browser because, for example, they require layout measurements, restrict it to the Chromium env by using `it.skipIf(isJSDOM)` or `describe.skipIf(isJSDOM)` (search other tests for example usage if unsure).
- Follow the established conventions in existing tests. Each file/component is tested with the filename `name.test.tsx`. For example, `PopoverRoot.test.tsx` is next to its source file `PopoverRoot.tsx`.
- Tests use `vitest`'s `expect()` and `fn()`, do not assume they have methods of other libraries' APIs. Search existing tests for example usage if unsure. The repository is transitioning from `chai` and `sinon`, prefer `vitest` native functions for all new code.

## Commit guidelines

- Commit messages follow the format `[scope] Imperative summary` (for example `[popover] Fix focus trap`). Choose scopes that mirror package or component names that were changed.
- Use `[all components]` scope for changes that broadly affect most components.

## Errors

These guidelines apply only to errors thrown by public packages.

Every error message must:

1. **Say what happened** - Describe the problem clearly
2. **Say why it's a problem** - Explain the consequence
3. **Point toward how to solve it** - Give actionable guidance

Format:

- Prefix with `Base UI: `
- Use string concatenation for readability
- Include a documentation link when applicable (`https://base-ui.com/...`)

### Error Minifier

You MUST run `pnpm extract-error-codes` to update `docs/src/error-codes.json` every time you add or update an error message in an `Error` constructor.

**Important:** If the update created a new error code, but the new and original message have the same number of arguments and semantics haven't changed, update the original error in `error-codes.json` instead of creating a new code.

## Documentation

### Autogenerated files

- `types.md` files (for example, `docs/src/app/(docs)/react/components/toggle/types.md`) are **autogenerated**. Do not edit them manually. They are regenerated when running `pnpm docs:dev` (on page visit), `pnpm docs:build`, or `pnpm docs:validate`.
- Some `page.mdx` files are **page indexes** (for example, `docs/src/app/(docs)/react/components/page.mdx`). You can tell because they contain a comment saying they are autogenerated. The list at the top of these files can be reordered and tagged (for example, `[New]`, `[Preview]`), but the outline content below the list should not be manually edited. Run `pnpm docs:build`, `pnpm docs:validate`, or `pnpm docs:dev` (on page visit) to regenerate it.
- Page indexes are useful for navigating the docs. Start at `docs/src/app/(docs)/react/page.mdx` to see a high-level overview, then follow links to narrow in on the specific page you need.

### Adding a new component's docs page

1. Create the component's page, for example, `docs/src/app/(docs)/react/components/button/page.mdx`.
2. Create a `types.ts` file next to the page. For a **single-part** component, use `createTypes`:

   ```ts
   import { Toggle } from '@base-ui/react/toggle';
   import { createTypes } from 'docs/src/utils/createTypes';

   export const TypesToggle = createTypes(import.meta.url, Toggle);
   ```

   For a **multi-part** component, use `createMultipleTypes`:

   ```ts
   import { Checkbox } from '@base-ui/react/checkbox';
   import { createMultipleTypes } from 'docs/src/utils/createTypes';

   const { types, AdditionalTypes } = createMultipleTypes(import.meta.url, Checkbox);

   export const TypesCheckbox = types;
   export const TypesCheckboxAdditional = AdditionalTypes;
   ```

3. Import and use the types component in the page:

   Single-part:

   ```mdx
   ## API Reference

   import { TypesToggle } from './types';

   <TypesToggle />
   ```

   Multi-part:

   ```mdx
   ## API Reference

   import { TypesCheckbox } from './types';

   ### Root

   <TypesCheckbox.Root />

   ### Indicator

   <TypesCheckbox.Indicator />
   ```

4. Start the dev server with `pnpm docs:dev` and visit the page (for example, `http://localhost:3005/react/components/toggle`). The `types.md` file is generated automatically. If you prefer not to open the browser, run `pnpm docs:build` to generate all files.

### Adding a demo

Create a demo component file inside a `demos/` directory next to the page, for example, `docs/src/app/(docs)/react/components/button/demos/basic/ButtonBasic.tsx`:

```tsx
import * as React from 'react';
import { Button } from '@base-ui/react/button';

export default function ButtonBasic() {
  return (
    <div>
      <Button>Basic Button</Button>
    </div>
  );
}
```

Then create an `index.ts` that wraps the component with `createDemo`:

```ts
import { createDemo } from 'docs/src/utils/createDemo';
import ButtonBasic from './ButtonBasic';

export const DemoButtonBasic = createDemo(import.meta.url, ButtonBasic);
```

For demos with multiple variants (for example, `Tailwind CSS` and `CSS Modules`), use `createDemoWithVariants`:

```ts
import { createDemoWithVariants } from 'docs/src/utils/createDemo';
import CssModules from './css-modules';
import Tailwind from './tailwind';

export const DemoButtonHero = createDemoWithVariants(import.meta.url, { CssModules, Tailwind });
```

### Page structure conventions

- The page **title** is derived from the `# h1` heading at the top of the `page.mdx`.
- The page **description** is derived from the `<Subtitle>` component immediately after the h1.
- Next.js `export const metadata = {}` should be placed at the **end** of the `page.mdx` file. It is typically used for SEO keywords. To hide a page from search engines, add `robots: { index: false }`.

```mdx
# Toggle

<Subtitle>A two-state button that can be on or off.</Subtitle>

<!-- page content -->

export const metadata = {
  keywords: ['React Toggle', 'Toggle Button Component'],
};
```
